generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                 @id @default(cuid())
  email                 String                 @unique
  passwordHash          String?
  fullName              String?
  role                  Role                   @default(MEMBER)
  status                UserStatus             @default(PENDING_ONBOARDING)
  whoopMemberId         String?                @unique
  profile               Profile?
  authProviders         AuthProvider[]
  whoopIntegration      WhoopIntegration?
  whoopLinkSessions     WhoopLinkSession[]
  insights              Insight[]
  insightActions        InsightAction[]        @relation("UserInsightActions")
  insightGenerationJobs InsightGenerationJob[] @relation("UserInsightJobs")
  biomarkerLogs         BiomarkerLog[]
  feedPosts             FeedPost[]             @relation("FeedPostAuthor")
  comments              Comment[]              @relation("CommentAuthor")
  reactions             Reaction[]             @relation("UserReactions")
  engagementEvents      EngagementEvent[]
  roomsHosted           Room[]                 @relation("RoomHost")
  roomMemberships       RoomMembership[]
  flagsOpened           Flag[]                 @relation("FlagOpenedBy")
  flagsResolved         Flag[]                 @relation("FlagResolvedBy")
  auditLogs             AdminAuditLog[]        @relation("UserAuditLogs")
  loginAudits           LoginAudit[]
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
}

model Profile {
  id                    String    @id @default(cuid())
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String    @unique
  displayName           String
  timezone              String
  baselineSurvey        Json?
  consents              Json?
  onboardingCompletedAt DateTime?
  deleteRequested       Boolean   @default(false)
  deletedAt             DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model Insight {
  id             String                 @id @default(cuid())
  user           User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  title          String
  summary        String
  body           Json?
  modelUsed      String?
  promptMetadata Json?
  status         InsightStatus          @default(DRAFT)
  generatedAt    DateTime               @default(now())
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  actions        InsightAction[]
  generationJobs InsightGenerationJob[] @relation("InsightJobs")
  flags          Flag[]                 @relation("InsightFlags")
}

model Biomarker {
  id            String          @id @default(cuid())
  slug          String          @unique
  name          String
  unit          String
  referenceLow  Decimal?        @db.Decimal(10, 4)
  referenceHigh Decimal?        @db.Decimal(10, 4)
  source        BiomarkerSource
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  logs          BiomarkerLog[]
}

model BiomarkerLog {
  id          String          @id @default(cuid())
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  biomarker   Biomarker       @relation(fields: [biomarkerId], references: [id], onDelete: Cascade)
  biomarkerId String
  value       Decimal         @db.Decimal(10, 4)
  unit        String?
  source      BiomarkerSource @default(MANUAL)
  capturedAt  DateTime
  accepted    Boolean         @default(true)
  flagged     Boolean         @default(false)
  notes       String?
  rawPayload  Json?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  flags       Flag[]          @relation("BiomarkerLogFlags")

  @@index([userId, biomarkerId, capturedAt])
}

model AuthProvider {
  id             String           @id @default(cuid())
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  type           AuthProviderType
  providerUserId String?
  accessToken    String?
  refreshToken   String?
  scopes         String[]         @default([])
  expiresAt      DateTime?
  linkedAt       DateTime         @default(now())
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@unique([userId, type])
  @@index([type, providerUserId])
}

model LoginAudit {
  id            String           @id @default(cuid())
  user          User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId        String?
  email         String
  provider      AuthProviderType
  success       Boolean
  ipAddress     String?
  userAgent     String?
  failureReason String?
  createdAt     DateTime         @default(now())

  @@index([email, createdAt])
  @@index([userId, createdAt])
}

model InsightAction {
  id         String            @id @default(cuid())
  insight    Insight           @relation(fields: [insightId], references: [id], onDelete: Cascade)
  insightId  String
  actor      User?             @relation("UserInsightActions", fields: [actorId], references: [id], onDelete: SetNull)
  actorId    String?
  actionType InsightActionType
  notes      String?
  createdAt  DateTime          @default(now())
}

model InsightGenerationJob {
  id            String                  @id @default(cuid())
  insight       Insight?                @relation("InsightJobs", fields: [insightId], references: [id], onDelete: SetNull)
  insightId     String?
  requestedBy   User?                   @relation("UserInsightJobs", fields: [requestedById], references: [id], onDelete: SetNull)
  requestedById String?
  status        InsightGenerationStatus
  cloudTaskName String?
  queue         String?
  payload       Json?
  scheduledAt   DateTime?
  dispatchedAt  DateTime?
  completedAt   DateTime?
  errorCode     String?
  errorMessage  String?
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  cloudTask     CloudTaskMetadata?      @relation("JobCloudTask")
}

model CloudTaskMetadata {
  id             String                @id @default(cuid())
  taskName       String                @unique
  queue          String
  status         CloudTaskStatus       @default(PENDING)
  job            InsightGenerationJob? @relation("JobCloudTask", fields: [jobId], references: [id], onDelete: SetNull)
  jobId          String?               @unique
  payload        Json?
  scheduleTime   DateTime?
  firstAttemptAt DateTime?
  lastAttemptAt  DateTime?
  attemptCount   Int                   @default(0)
  errorMessage   String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
}

model WhoopIntegration {
  id             String          @id @default(cuid())
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String          @unique
  whoopUserId    String?         @unique
  accessToken    String?
  refreshToken   String?
  expiresAt      DateTime?
  scope          String[]        @default([])
  tokenKeyId     String?
  tokenRotatedAt DateTime?
  syncStatus     WhoopSyncStatus @default(PENDING)
  lastSyncedAt   DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model WhoopLinkSession {
  id          String    @id @default(cuid())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  state       String    @unique
  redirectUri String
  scope       String[]  @default([])
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  completedAt DateTime?
  cancelledAt DateTime?

  @@index([userId, expiresAt])
}

model FeedPost {
  id               String            @id @default(cuid())
  author           User              @relation("FeedPostAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  authorId         String
  body             String
  tags             String[]          @default([])
  visibility       PostVisibility    @default(MEMBERS)
  flagged          Boolean           @default(false)
  reactionSummary  Json?
  commentCount     Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  comments         Comment[]
  reactions        Reaction[]        @relation("PostReactions")
  flags            Flag[]            @relation("PostFlags")
  engagementEvents EngagementEvent[]
}

model Comment {
  id               String            @id @default(cuid())
  post             FeedPost          @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId           String
  author           User              @relation("CommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  authorId         String
  body             String
  flagged          Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  reactions        Reaction[]        @relation("CommentReactions")
  flags            Flag[]            @relation("CommentFlags")
  engagementEvents EngagementEvent[]
}

model Reaction {
  id        String       @id @default(cuid())
  type      ReactionType
  post      FeedPost?    @relation("PostReactions", fields: [postId], references: [id], onDelete: Cascade)
  postId    String?
  comment   Comment?     @relation("CommentReactions", fields: [commentId], references: [id], onDelete: Cascade)
  commentId String?
  user      User         @relation("UserReactions", fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime     @default(now())
}

model EngagementEvent {
  id           String              @id @default(cuid())
  type         EngagementEventType
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  post         FeedPost?           @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId       String?
  comment      Comment?            @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId    String?
  reactionType ReactionType?
  occurredAt   DateTime            @default(now())
  metadata     Json?

  @@index([userId, occurredAt])
  @@index([type, occurredAt])
}

model Flag {
  id             String         @id @default(cuid())
  targetType     FlagTargetType
  status         FlagStatus     @default(OPEN)
  reason         String
  post           FeedPost?      @relation("PostFlags", fields: [postId], references: [id], onDelete: Cascade)
  postId         String?
  comment        Comment?       @relation("CommentFlags", fields: [commentId], references: [id], onDelete: Cascade)
  commentId      String?
  insight        Insight?       @relation("InsightFlags", fields: [insightId], references: [id], onDelete: Cascade)
  insightId      String?
  biomarkerLog   BiomarkerLog?  @relation("BiomarkerLogFlags", fields: [biomarkerLogId], references: [id], onDelete: Cascade)
  biomarkerLogId String?
  openedBy       User           @relation("FlagOpenedBy", fields: [openedById], references: [id], onDelete: Cascade)
  openedById     String
  resolvedBy     User?          @relation("FlagResolvedBy", fields: [resolvedById], references: [id], onDelete: SetNull)
  resolvedById   String?
  resolvedAt     DateTime?
  auditTrail     Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([targetType, status])
}

model AdminAuditLog {
  id         String   @id @default(cuid())
  actor      User     @relation("UserAuditLogs", fields: [actorId], references: [id], onDelete: Cascade)
  actorId    String
  action     String
  targetType String
  targetId   String?
  metadata   Json?
  createdAt  DateTime @default(now())
}

enum Role {
  MEMBER
  COACH
  MODERATOR
  ADMIN
}

enum UserStatus {
  PENDING_ONBOARDING
  ACTIVE
  SUSPENDED
}

enum BiomarkerSource {
  WHOOP
  MANUAL
  LAB_UPLOAD
}

enum InsightStatus {
  DRAFT
  DELIVERED
  ARCHIVED
}

enum PostVisibility {
  MEMBERS
  COHORT
  PUBLIC
}

enum AuthProviderType {
  EMAIL_PASSWORD
  GOOGLE
  APPLE
  WHOOP
}

enum InsightActionType {
  ACCEPTED
  DISMISSED
  RETRY_REQUESTED
  FEEDBACK_LEFT
}

enum InsightGenerationStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum ReactionType {
  BOOST
  HIGH_FIVE
  NOTEWORTHY
}

enum WhoopSyncStatus {
  PENDING
  ACTIVE
}

enum FlagTargetType {
  POST
  COMMENT
  INSIGHT
  BIOMARKER_LOG
}

enum FlagStatus {
  OPEN
  TRIAGED
  RESOLVED
}

enum EngagementEventType {
  POST_CREATED
  POST_DELETED
  COMMENT_CREATED
  COMMENT_DELETED
  REACTION_ADDED
  REACTION_REMOVED
}

model Room {
  id          String           @id @default(cuid())
  name        String?
  inviteCode  String           @unique
  status      RoomStatus       @default(LOBBY)
  capacity    Int
  host        User             @relation("RoomHost", fields: [hostId], references: [id], onDelete: Cascade)
  hostId      String
  memberships RoomMembership[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model RoomMembership {
  id             String               @id @default(cuid())
  room           Room                 @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomId         String
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  role           RoomMembershipRole   @default(PLAYER)
  status         RoomMembershipStatus @default(ACTIVE)
  joinedAt       DateTime             @default(now())
  leftAt         DateTime?
  lastSeenAt     DateTime?
  reconnectToken String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  @@unique([roomId, userId])
  @@index([roomId, status])
}

enum RoomStatus {
  LOBBY
  ACTIVE
  COMPLETED
  CANCELLED
}

enum RoomMembershipRole {
  HOST
  PLAYER
  SPECTATOR
}

enum RoomMembershipStatus {
  ACTIVE
  LEFT
  SPECTATOR
}

enum CloudTaskStatus {
  PENDING
  DISPATCHED
  SUCCEEDED
  FAILED
}
