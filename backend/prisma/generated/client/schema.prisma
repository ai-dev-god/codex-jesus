generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                          String                       @id @default(cuid())
  email                       String                       @unique
  passwordHash                String?
  fullName                    String?
  role                        Role                         @default(MEMBER)
  status                      UserStatus                   @default(PENDING_ONBOARDING)
  whoopMemberId               String?                      @unique
  profile                     Profile?
  authProviders               AuthProvider[]
  whoopIntegration            WhoopIntegration?
  whoopLinkSessions           WhoopLinkSession[]
  whoopWorkouts               WhoopWorkout[]
  stravaIntegration           StravaIntegration?
  stravaLinkSessions          StravaLinkSession[]
  stravaActivities            StravaActivity[]
  insights                    Insight[]
  insightActions              InsightAction[]              @relation("UserInsightActions")
  insightGenerationJobs       InsightGenerationJob[]       @relation("UserInsightJobs")
  biomarkerLogs               BiomarkerLog[]
  panelUploads                PanelUpload[]
  panelUploadSessions         PanelUploadSession[]
  biomarkerMeasurements       BiomarkerMeasurement[]
  feedPosts                   FeedPost[]                   @relation("FeedPostAuthor")
  comments                    Comment[]                    @relation("CommentAuthor")
  reactions                   Reaction[]                   @relation("UserReactions")
  engagementEvents            EngagementEvent[]
  roomsHosted                 Room[]                       @relation("RoomHost")
  roomMemberships             RoomMembership[]
  flagsOpened                 Flag[]                       @relation("FlagOpenedBy")
  flagsResolved               Flag[]                       @relation("FlagResolvedBy")
  auditLogs                   AdminAuditLog[]              @relation("UserAuditLogs")
  longevityPlans              LongevityPlan[]
  longevityPlanJobs           LongevityPlanJob[]           @relation("UserLongevityPlanJobs")
  aiResponseAudits            AiResponseAudit[]
  loginAudits                 LoginAudit[]
  apiKeysCreated              ServiceApiKey[]              @relation("ApiKeysCreatedBy")
  apiKeysRevoked              ServiceApiKey[]              @relation("ApiKeysRevokedBy")
  backupJobsInitiated         AdminBackupJob[]             @relation("BackupJobInitiatedBy")
  panelDownloadTokens         PanelUploadDownloadToken[]
  membershipInvitesCreated    MembershipInvite[]           @relation("MembershipInvitesCreated")
  membershipInviteRedemptions MembershipInviteRedemption[]
  dataExportJobs              DataExportJob[]
  dataDeletionJobs            DataDeletionJob[]
  createdAt                   DateTime                     @default(now())
  updatedAt                   DateTime                     @updatedAt
}

model Profile {
  id                         String    @id @default(cuid())
  user                       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                     String    @unique
  displayName                String
  timezone                   String
  baselineSurvey             Json?
  consents                   Json?
  onboardingCompletedAt      DateTime?
  deleteRequested            Boolean   @default(false)
  deletedAt                  DateTime?
  aiInterpretationApprovedAt DateTime?
  aiInterpretationApprovedBy String?
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt
}

model Insight {
  id             String                 @id @default(cuid())
  user           User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  title          String
  summary        String
  body           Json?
  modelUsed      String?
  promptMetadata Json?
  status         InsightStatus          @default(DRAFT)
  generatedAt    DateTime               @default(now())
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  actions        InsightAction[]
  generationJobs InsightGenerationJob[] @relation("InsightJobs")
  flags          Flag[]                 @relation("InsightFlags")
}

model LongevityPlan {
  id           String              @id @default(cuid())
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  status       LongevityPlanStatus @default(DRAFT)
  title        String
  summary      String?
  focusAreas   String[]            @default([])
  sections     Json?
  evidence     Json?
  safetyState  Json?
  validatedBy  String?
  validatedAt  DateTime?
  requestedAt  DateTime            @default(now())
  completedAt  DateTime?
  errorCode    String?
  errorMessage String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  jobs         LongevityPlanJob[]
  audits       AiResponseAudit[]
  panelUploads PanelUpload[]

  @@index([userId, createdAt])
}

model Biomarker {
  id              String                    @id @default(cuid())
  slug            String                    @unique
  name            String
  unit            String
  referenceLow    Decimal?                  @db.Decimal(10, 4)
  referenceHigh   Decimal?                  @db.Decimal(10, 4)
  source          BiomarkerSource
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  logs            BiomarkerLog[]
  measurements    BiomarkerMeasurement[]
  panelUploadTags PanelUploadBiomarkerTag[]
}

model BiomarkerLog {
  id          String          @id @default(cuid())
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  biomarker   Biomarker       @relation(fields: [biomarkerId], references: [id], onDelete: Cascade)
  biomarkerId String
  value       Decimal         @db.Decimal(10, 4)
  unit        String?
  source      BiomarkerSource @default(MANUAL)
  capturedAt  DateTime
  accepted    Boolean         @default(true)
  flagged     Boolean         @default(false)
  notes       String?
  rawPayload  Json?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  flags       Flag[]          @relation("BiomarkerLogFlags")

  @@index([userId, biomarkerId, capturedAt])
}

model PanelUpload {
  id                String                     @id @default(cuid())
  user              User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String
  status            PanelUploadStatus          @default(PENDING)
  source            PanelUploadSource          @default(LAB_REPORT)
  storageKey        String
  contentType       String?
  byteSize          Int?
  sha256Hash        String?
  pageCount         Int?
  rawMetadata       Json?
  normalizedPayload Json?
  measurementCount  Int                        @default(0)
  processedAt       DateTime?
  errorCode         String?
  errorMessage      String?
  plan              LongevityPlan?             @relation(fields: [planId], references: [id], onDelete: SetNull)
  planId            String?
  biomarkerTags     PanelUploadBiomarkerTag[]
  sealedStorageKey  String?
  sealedKeyVersion  String?
  uploadSession     PanelUploadSession?        @relation(fields: [uploadSessionId], references: [id], onDelete: SetNull)
  uploadSessionId   String?
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  measurements      BiomarkerMeasurement[]
  downloadTokens    PanelUploadDownloadToken[]

  @@index([userId, createdAt])
  @@index([planId])
  @@index([uploadSessionId])
}

model BiomarkerMeasurement {
  id            String            @id @default(cuid())
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  biomarker     Biomarker?        @relation(fields: [biomarkerId], references: [id], onDelete: SetNull)
  biomarkerId   String?
  panelUpload   PanelUpload?      @relation(fields: [panelUploadId], references: [id], onDelete: SetNull)
  panelUploadId String?
  markerName    String
  value         Decimal?          @db.Decimal(10, 4)
  unit          String?
  referenceLow  Decimal?          @db.Decimal(10, 4)
  referenceHigh Decimal?          @db.Decimal(10, 4)
  capturedAt    DateTime?
  status        MeasurementStatus @default(RAW)
  source        BiomarkerSource   @default(LAB_UPLOAD)
  confidence    Decimal?          @db.Decimal(5, 4)
  flags         Json?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([userId, capturedAt])
}

model PanelUploadBiomarkerTag {
  id            String      @id @default(cuid())
  panelUpload   PanelUpload @relation(fields: [panelUploadId], references: [id], onDelete: Cascade)
  panelUploadId String
  biomarker     Biomarker   @relation(fields: [biomarkerId], references: [id], onDelete: Cascade)
  biomarkerId   String
  taggedAt      DateTime    @default(now())

  @@unique([panelUploadId, biomarkerId])
  @@index([biomarkerId])
}

model PanelUploadDownloadToken {
  id        String      @id @default(cuid())
  token     String      @unique
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  upload    PanelUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  uploadId  String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime    @default(now())

  @@index([expiresAt])
}

model PanelUploadSession {
  id          String                   @id @default(cuid())
  user        User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  storageKey  String                   @unique
  contentType String
  byteSize    Int
  sha256Hash  String
  kmsKeyName  String?
  expiresAt   DateTime
  usedAt      DateTime?
  status      PanelUploadSessionStatus @default(PENDING)
  createdAt   DateTime                 @default(now())
  uploads     PanelUpload[]

  @@index([userId])
  @@index([status, expiresAt])
}

enum PanelUploadSessionStatus {
  PENDING
  USED
  EXPIRED
}

model AuthProvider {
  id             String           @id @default(cuid())
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  type           AuthProviderType
  providerUserId String?
  accessToken    String?
  refreshToken   String?
  scopes         String[]         @default([])
  expiresAt      DateTime?
  linkedAt       DateTime         @default(now())
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@unique([userId, type])
  @@index([type, providerUserId])
}

model LoginAudit {
  id            String           @id @default(cuid())
  user          User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId        String?
  email         String
  provider      AuthProviderType
  success       Boolean
  ipAddress     String?
  userAgent     String?
  failureReason String?
  createdAt     DateTime         @default(now())

  @@index([email, createdAt])
  @@index([userId, createdAt])
}

model InsightAction {
  id         String            @id @default(cuid())
  insight    Insight           @relation(fields: [insightId], references: [id], onDelete: Cascade)
  insightId  String
  actor      User?             @relation("UserInsightActions", fields: [actorId], references: [id], onDelete: SetNull)
  actorId    String?
  actionType InsightActionType
  notes      String?
  createdAt  DateTime          @default(now())
}

model InsightGenerationJob {
  id            String                  @id @default(cuid())
  insight       Insight?                @relation("InsightJobs", fields: [insightId], references: [id], onDelete: SetNull)
  insightId     String?
  requestedBy   User?                   @relation("UserInsightJobs", fields: [requestedById], references: [id], onDelete: SetNull)
  requestedById String?
  status        InsightGenerationStatus
  cloudTaskName String?
  queue         String?
  payload       Json?
  scheduledAt   DateTime?
  dispatchedAt  DateTime?
  completedAt   DateTime?
  errorCode     String?
  errorMessage  String?
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  cloudTask     CloudTaskMetadata?      @relation("JobCloudTask")
}

model LongevityPlanJob {
  id            String                 @id @default(cuid())
  plan          LongevityPlan?         @relation(fields: [planId], references: [id], onDelete: SetNull)
  planId        String?
  requestedBy   User?                  @relation("UserLongevityPlanJobs", fields: [requestedById], references: [id], onDelete: SetNull)
  requestedById String?
  status        LongevityPlanJobStatus @default(QUEUED)
  cloudTaskName String?
  queue         String?
  payload       Json?
  scheduledAt   DateTime?
  dispatchedAt  DateTime?
  completedAt   DateTime?
  errorCode     String?
  errorMessage  String?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  cloudTask     CloudTaskMetadata?     @relation("LongevityPlanJobTask")
}

model CloudTaskMetadata {
  id             String                @id @default(cuid())
  taskName       String                @unique
  queue          String
  status         CloudTaskStatus       @default(PENDING)
  job            InsightGenerationJob? @relation("JobCloudTask", fields: [jobId], references: [id], onDelete: SetNull)
  jobId          String?               @unique
  planJob        LongevityPlanJob?     @relation("LongevityPlanJobTask", fields: [planJobId], references: [id], onDelete: SetNull)
  planJobId      String?               @unique
  payload        Json?
  scheduleTime   DateTime?
  firstAttemptAt DateTime?
  lastAttemptAt  DateTime?
  attemptCount   Int                   @default(0)
  errorMessage   String?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
}

model WhoopIntegration {
  id             String          @id @default(cuid())
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String          @unique
  whoopUserId    String?         @unique
  accessToken    String?
  refreshToken   String?
  expiresAt      DateTime?
  scope          String[]        @default([])
  tokenKeyId     String?
  tokenRotatedAt DateTime?
  syncStatus     WhoopSyncStatus @default(PENDING)
  lastSyncedAt   DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model WhoopLinkSession {
  id          String    @id @default(cuid())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  state       String    @unique
  redirectUri String
  scope       String[]  @default([])
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  completedAt DateTime?
  cancelledAt DateTime?

  @@index([userId, expiresAt])
}

enum StravaSyncStatus {
  PENDING
  ACTIVE
  ERROR
  REVOKED
}

model StravaIntegration {
  id               String           @id @default(cuid())
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           String           @unique
  athleteId        Int?
  athleteUsername  String?
  athleteName      String?
  athleteAvatarUrl String?
  athleteCity      String?
  athleteCountry   String?
  accessToken      String?
  refreshToken     String?
  expiresAt        DateTime?
  scope            String[]         @default([])
  syncStatus       StravaSyncStatus @default(PENDING)
  lastSyncedAt     DateTime?
  lastSyncSummary  Json?
  tokenKeyId       String?
  tokenRotatedAt   DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  activities       StravaActivity[]
}

model StravaLinkSession {
  id          String    @id @default(cuid())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  state       String    @unique
  redirectUri String
  scope       String[]  @default([])
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  completedAt DateTime?
  cancelledAt DateTime?

  @@index([userId, expiresAt])
}

model StravaActivity {
  id                  String            @id @default(cuid())
  integration         StravaIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  integrationId       String
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String
  stravaActivityId    String            @unique
  name                String
  sportType           String
  distanceMeters      Float?
  movingTimeSeconds   Int?
  elapsedTimeSeconds  Int?
  elevationGainMeters Float?
  averageSpeedMps     Float?
  maxSpeedMps         Float?
  averageWatts        Float?
  maxWatts            Float?
  sufferScore         Float?
  achievements        Int?
  kudosCount          Int?
  startDate           DateTime
  startDateLocal      DateTime?
  isCommute           Boolean?
  isTrainer           Boolean?
  rawPayload          Json?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([userId, startDate])
  @@index([integrationId, startDate])
}

model MembershipInvite {
  id             String                       @id @default(cuid())
  code           String                       @unique
  email          String?
  status         MembershipInviteStatus       @default(ACTIVE)
  maxUses        Int                          @default(1)
  usedCount      Int                          @default(0)
  expiresAt      DateTime?
  metadata       Json?
  createdBy      User?                        @relation("MembershipInvitesCreated", fields: [createdById], references: [id], onDelete: SetNull)
  createdById    String?
  lastRedeemedAt DateTime?
  redemptions    MembershipInviteRedemption[]
  createdAt      DateTime                     @default(now())
  updatedAt      DateTime                     @updatedAt

  @@index([email])
  @@index([status, expiresAt])
}

model MembershipInviteRedemption {
  id         String           @id @default(cuid())
  invite     MembershipInvite @relation(fields: [inviteId], references: [id], onDelete: Cascade)
  inviteId   String
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  email      String
  redeemedAt DateTime         @default(now())

  @@index([inviteId, redeemedAt])
  @@index([userId, redeemedAt])
}

model WhoopWorkout {
  id                    String    @id @default(cuid())
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String
  whoopUserId           String
  whoopWorkoutId        String    @unique
  sport                 String
  sportCategory         String?
  sportTypeId           Int?
  scoreState            String?
  intensityLevel        String?
  startTime             DateTime
  endTime               DateTime?
  durationSeconds       Int?
  timezoneOffsetMinutes Int?
  strain                Decimal?  @db.Decimal(5, 2)
  avgHeartRate          Int?
  maxHeartRate          Int?
  calories              Int?
  distanceMeters        Int?
  energyKilojoule       Int?
  rawPayload            Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId, startTime])
  @@index([whoopUserId, startTime])
}

model FeedPost {
  id               String            @id @default(cuid())
  author           User              @relation("FeedPostAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  authorId         String
  body             String
  tags             String[]          @default([])
  visibility       PostVisibility    @default(MEMBERS)
  flagged          Boolean           @default(false)
  reactionSummary  Json?
  commentCount     Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  comments         Comment[]
  reactions        Reaction[]        @relation("PostReactions")
  flags            Flag[]            @relation("PostFlags")
  engagementEvents EngagementEvent[]
}

model Comment {
  id               String            @id @default(cuid())
  post             FeedPost          @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId           String
  author           User              @relation("CommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  authorId         String
  body             String
  flagged          Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  reactions        Reaction[]        @relation("CommentReactions")
  flags            Flag[]            @relation("CommentFlags")
  engagementEvents EngagementEvent[]
}

model Reaction {
  id        String       @id @default(cuid())
  type      ReactionType
  post      FeedPost?    @relation("PostReactions", fields: [postId], references: [id], onDelete: Cascade)
  postId    String?
  comment   Comment?     @relation("CommentReactions", fields: [commentId], references: [id], onDelete: Cascade)
  commentId String?
  user      User         @relation("UserReactions", fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime     @default(now())
}

model EngagementEvent {
  id           String              @id @default(cuid())
  type         EngagementEventType
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  post         FeedPost?           @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId       String?
  comment      Comment?            @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId    String?
  reactionType ReactionType?
  occurredAt   DateTime            @default(now())
  metadata     Json?

  @@index([userId, occurredAt])
  @@index([type, occurredAt])
}

model Flag {
  id             String         @id @default(cuid())
  targetType     FlagTargetType
  status         FlagStatus     @default(OPEN)
  reason         String
  post           FeedPost?      @relation("PostFlags", fields: [postId], references: [id], onDelete: Cascade)
  postId         String?
  comment        Comment?       @relation("CommentFlags", fields: [commentId], references: [id], onDelete: Cascade)
  commentId      String?
  insight        Insight?       @relation("InsightFlags", fields: [insightId], references: [id], onDelete: Cascade)
  insightId      String?
  biomarkerLog   BiomarkerLog?  @relation("BiomarkerLogFlags", fields: [biomarkerLogId], references: [id], onDelete: Cascade)
  biomarkerLogId String?
  openedBy       User           @relation("FlagOpenedBy", fields: [openedById], references: [id], onDelete: Cascade)
  openedById     String
  resolvedBy     User?          @relation("FlagResolvedBy", fields: [resolvedById], references: [id], onDelete: SetNull)
  resolvedById   String?
  resolvedAt     DateTime?
  auditTrail     Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([targetType, status])
}

model AdminAuditLog {
  id         String   @id @default(cuid())
  actor      User     @relation("UserAuditLogs", fields: [actorId], references: [id], onDelete: Cascade)
  actorId    String
  action     String
  targetType String
  targetId   String?
  metadata   Json?
  createdAt  DateTime @default(now())
}

model AdminBackupJob {
  id              String            @id @default(cuid())
  type            AdminBackupType   @default(FULL)
  status          AdminBackupStatus @default(QUEUED)
  initiatedBy     User?             @relation("BackupJobInitiatedBy", fields: [initiatedById], references: [id], onDelete: SetNull)
  initiatedById   String?
  storageUri      String?
  sizeBytes       BigInt?
  durationSeconds Int?
  startedAt       DateTime?
  completedAt     DateTime?
  failureReason   String?
  metadata        Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

model ServiceApiKey {
  id            String              @id @default(cuid())
  name          String
  prefix        String              @unique
  suffix        String
  hashedSecret  String
  scope         ServiceApiKeyScope  @default(READ)
  status        ServiceApiKeyStatus @default(ACTIVE)
  createdBy     User?               @relation("ApiKeysCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  createdById   String?
  revokedBy     User?               @relation("ApiKeysRevokedBy", fields: [revokedById], references: [id], onDelete: SetNull)
  revokedById   String?
  revokedAt     DateTime?
  lastRotatedAt DateTime?
  lastUsedAt    DateTime?
  lastUsedIp    String?
  requestCount  Int                 @default(0)
  metadata      Json?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
}

model DataExportJob {
  id           String              @id @default(cuid())
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  status       DataExportJobStatus @default(QUEUED)
  result       Json?
  errorMessage String?
  requestedAt  DateTime            @default(now())
  processedAt  DateTime?
  completedAt  DateTime?
  expiresAt    DateTime?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([userId, requestedAt])
}

model DataDeletionJob {
  id             String                @id @default(cuid())
  user           User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  status         DataDeletionJobStatus @default(QUEUED)
  deletedSummary Json?
  errorMessage   String?
  requestedAt    DateTime              @default(now())
  processedAt    DateTime?
  completedAt    DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  @@index([userId, requestedAt])
}

model AiResponseAudit {
  id        String         @id @default(cuid())
  plan      LongevityPlan? @relation(fields: [planId], references: [id], onDelete: SetNull)
  planId    String?
  user      User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId    String?
  provider  String
  model     String?
  role      String?
  prompt    Json?
  response  Json?
  createdAt DateTime       @default(now())
}

enum Role {
  MEMBER
  COACH
  PRACTITIONER
  MODERATOR
  ADMIN
}

enum UserStatus {
  PENDING_ONBOARDING
  ACTIVE
  SUSPENDED
}

enum BiomarkerSource {
  WHOOP
  MANUAL
  LAB_UPLOAD
}

enum PanelUploadStatus {
  PENDING
  NORMALIZED
  FAILED
}

enum PanelUploadSource {
  LAB_REPORT
  WEARABLE_EXPORT
  MANUAL_ENTRY
}

enum MeasurementStatus {
  RAW
  NORMALIZED
  VERIFIED
  REJECTED
}

enum InsightStatus {
  DRAFT
  DELIVERED
  ARCHIVED
}

enum LongevityPlanStatus {
  DRAFT
  PROCESSING
  READY
  FAILED
  ARCHIVED
}

enum LongevityPlanJobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum PostVisibility {
  MEMBERS
  COHORT
  PUBLIC
}

enum AuthProviderType {
  EMAIL_PASSWORD
  GOOGLE
  APPLE
  WHOOP
}

enum InsightActionType {
  ACCEPTED
  DISMISSED
  RETRY_REQUESTED
  FEEDBACK_LEFT
}

enum InsightGenerationStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum ReactionType {
  BOOST
  HIGH_FIVE
  NOTEWORTHY
}

enum WhoopSyncStatus {
  PENDING
  ACTIVE
}

enum FlagTargetType {
  POST
  COMMENT
  INSIGHT
  BIOMARKER_LOG
}

enum FlagStatus {
  OPEN
  TRIAGED
  RESOLVED
}

enum AdminBackupType {
  FULL
  INCREMENTAL
}

enum AdminBackupStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum ServiceApiKeyScope {
  READ
  WRITE
  FULL
}

enum ServiceApiKeyStatus {
  ACTIVE
  REVOKED
}

enum EngagementEventType {
  POST_CREATED
  POST_DELETED
  COMMENT_CREATED
  COMMENT_DELETED
  REACTION_ADDED
  REACTION_REMOVED
}

enum DataExportJobStatus {
  QUEUED
  IN_PROGRESS
  COMPLETE
  FAILED
}

enum DataDeletionJobStatus {
  QUEUED
  IN_PROGRESS
  COMPLETE
  FAILED
}

model Room {
  id          String           @id @default(cuid())
  name        String?
  inviteCode  String           @unique
  status      RoomStatus       @default(LOBBY)
  capacity    Int
  host        User             @relation("RoomHost", fields: [hostId], references: [id], onDelete: Cascade)
  hostId      String
  memberships RoomMembership[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model RoomMembership {
  id             String               @id @default(cuid())
  room           Room                 @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomId         String
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  role           RoomMembershipRole   @default(PLAYER)
  status         RoomMembershipStatus @default(ACTIVE)
  joinedAt       DateTime             @default(now())
  leftAt         DateTime?
  lastSeenAt     DateTime?
  reconnectToken String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  @@unique([roomId, userId])
  @@index([roomId, status])
}

enum RoomStatus {
  LOBBY
  ACTIVE
  COMPLETED
  CANCELLED
}

enum RoomMembershipRole {
  HOST
  PLAYER
  SPECTATOR
}

enum RoomMembershipStatus {
  ACTIVE
  LEFT
  SPECTATOR
}

enum CloudTaskStatus {
  PENDING
  DISPATCHED
  SUCCEEDED
  FAILED
}

enum MembershipInviteStatus {
  ACTIVE
  REDEEMED
  REVOKED
  EXPIRED
}
