# This workflow builds and pushes the Frontend Docker container to Google Artifact Registry
# and deploys it on Cloud Run when a commit is pushed to the "main" branch
# affecting the "bh-fe" directory.

name: 'Frontend Build and Deploy'

on:
  push:
    branches:
      - 'main'
    paths:
      - 'bh-fe/**'

env:
  PROJECT_ID: 'biohax-777'
  REGION: 'europe-west1'
  SERVICE: 'bh-fe-final'
  REPO_NAME: 'biohax'
  # Using the hardcoded URL from previous configuration.
  # Ideally, this should be dynamic or a stable custom domain.
  VITE_API_BASE_URL: 'https://bh-backend-final-714223448245.europe-west1.run.app'
  # TODO: Update to your Workload Identity Provider
  WORKLOAD_IDENTITY_PROVIDER: 'projects/123456789/locations/global/workloadIdentityPools/my-pool/providers/my-provider'

jobs:
  deploy:
    runs-on: 'ubuntu-latest'

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332' # actions/checkout@v4

      # Configure Workload Identity Federation
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@f112390a2df9932162083945e46d439060d66ec2' # google-github-actions/auth@v2
        with:
          workload_identity_provider: '${{ env.WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: 'codexjesus@biohax-777.iam.gserviceaccount.com'

      # Access Secret Manager for build args
      - id: 'secrets'
        name: 'Get Secrets'
        uses: 'google-github-actions/get-secretmanager-secrets@v2'
        with:
          secrets: |-
            VITE_GOOGLE_CLIENT_ID:${{ env.PROJECT_ID }}/google-client-id

      - name: 'Docker Auth'
        uses: 'docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567' # docker/login-action@v3
        with:
          username: 'oauth2accesstoken'
          password: '${{ steps.auth.outputs.auth_token }}'
          registry: '${{ env.REGION }}-docker.pkg.dev'

      - name: 'Build and Push Container'
        run: |-
          DOCKER_TAG="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE }}:${{ github.sha }}"
          
          # Build with build arguments from env and secrets
          docker build \
            --build-arg VITE_API_BASE_URL="${{ env.VITE_API_BASE_URL }}" \
            --build-arg VITE_GOOGLE_CLIENT_ID="${{ steps.secrets.outputs.VITE_GOOGLE_CLIENT_ID }}" \
            --tag "${DOCKER_TAG}" \
            bh-fe

          docker push "${DOCKER_TAG}"

      - name: 'Deploy to Cloud Run'
        uses: 'google-github-actions/deploy-cloudrun@33553064113a37d688aa6937bacbdc481580be17' # google-github-actions/deploy-cloudrun@v2
        with:
          service: '${{ env.SERVICE }}'
          region: '${{ env.REGION }}'
          image: '${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE }}:${{ github.sha }}'
          flags: '--allow-unauthenticated'

      - name: 'Show output'
        run: |2-
          echo ${{ steps.deploy.outputs.url }}

