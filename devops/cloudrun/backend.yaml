apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: bh-backend-final
  annotations:
    run.googleapis.com/launch-stage: GA
    run.googleapis.com/description: BioHax production backend (Express + Prisma)
spec:
  template:
    metadata:
      annotations:
        run.googleapis.com/cloudsql-instances: biohax-777:europe-west1:biohax-sql
        run.googleapis.com/ingress: all
        run.googleapis.com/vpc-access-egress: all-traffic
        run.googleapis.com/execution-environment: gen2
        run.googleapis.com/client-name: codex-jesus
        autoscaling.knative.dev/minScale: "0"
        autoscaling.knative.dev/maxScale: "4"
    spec:
      serviceAccountName: codexjesus@biohax-777.iam.gserviceaccount.com
      containerConcurrency: 80
      timeoutSeconds: 60
      containers:
        - image: europe-west1-docker.pkg.dev/biohax-777/biohax/bh-backend-final:latest
          ports:
            - containerPort: 8080
          resources:
            limits:
              cpu: "1"
              memory: 1Gi
          env:
            - name: NODE_ENV
              value: production
            - name: GCP_PROJECT_ID
              value: biohax-777
            - name: CORS_ORIGIN
              value: https://biohax.pro https://staging.biohax.pro http://localhost:5173 http://localhost:3000 http://127.0.0.1:5173 http://127.0.0.1:3000
            - name: WHOOP_REDIRECT_URI
              value: https://biohax.pro/oauth/whoop/callback
            - name: WHOOP_TOKEN_KEY_ID
              value: whoop-token-key-v1
            - name: AUTH_ACCESS_TOKEN_TTL_SECONDS
              value: "900"
            - name: AUTH_REFRESH_TOKEN_TTL_SECONDS
              value: "2592000"
            - name: DASHBOARD_CACHE_TTL_SECONDS
              value: "300"
            - name: DASHBOARD_SNAPSHOT_TTL_SECONDS
              value: "900"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: database-url
                  key: latest
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: redis-url
                  key: latest
            - name: AUTH_JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: jwt-secret
                  key: latest
            - name: AUTH_REFRESH_ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: auth-refresh-encryption-key
                  key: latest
            - name: OPENROUTER_API_KEY
              valueFrom:
                secretKeyRef:
                  name: openrouter-api-key
                  key: latest
            - name: WHOOP_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: whoop-client-id
                  key: latest
            - name: WHOOP_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: whoop-client-secret
                  key: latest
            - name: WHOOP_TOKEN_ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: whoop-token-encryption-key
                  key: latest
            - name: GOOGLE_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: google-client-id
                  key: latest
            - name: GOOGLE_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: google-client-secret
                  key: latest
            - name: RESEND_API_KEY
              valueFrom:
                secretKeyRef:
                  name: resend-api-key
                  key: latest

