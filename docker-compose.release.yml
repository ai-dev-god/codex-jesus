version: "3.9"

services:
  postgres:
    image: postgres:16.4
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-biohax}
      POSTGRES_USER: ${POSTGRES_USER:-biohax}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-biohax}
    ports:
      - "${POSTGRES_PORT:-6543}:5432"
    volumes:
      - release_postgres:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-biohax} -d ${POSTGRES_DB:-biohax}"
        ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

  backend:
    image: ${BACKEND_IMAGE:-biohax-backend:latest}
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: ${BACKEND_PORT:-4000}
      DATABASE_URL: ${DATABASE_URL:-postgresql://biohax:biohax@postgres:5432/biohax?schema=public}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:${FRONTEND_PORT:-8080}}
      AUTH_JWT_SECRET: ${AUTH_JWT_SECRET:?AUTH_JWT_SECRET is required}
      AUTH_REFRESH_ENCRYPTION_KEY: ${AUTH_REFRESH_ENCRYPTION_KEY:?AUTH_REFRESH_ENCRYPTION_KEY is required}
      AUTH_ACCESS_TOKEN_TTL_SECONDS: ${AUTH_ACCESS_TOKEN_TTL_SECONDS:-900}
      AUTH_REFRESH_TOKEN_TTL_SECONDS: ${AUTH_REFRESH_TOKEN_TTL_SECONDS:-2592000}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      WHOOP_CLIENT_ID: ${WHOOP_CLIENT_ID:-}
      WHOOP_CLIENT_SECRET: ${WHOOP_CLIENT_SECRET:-}
      WHOOP_TOKEN_ENCRYPTION_KEY: ${WHOOP_TOKEN_ENCRYPTION_KEY:?WHOOP_TOKEN_ENCRYPTION_KEY is required}
      WHOOP_TOKEN_KEY_ID: ${WHOOP_TOKEN_KEY_ID:-whoop-token-key-v1}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      WHOOP_REDIRECT_URI: ${WHOOP_REDIRECT_URI:-http://localhost:${FRONTEND_PORT:-8080}/oauth/whoop/callback}
    ports:
      - "${BACKEND_PORT:-4000}:4000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/healthz/readiness"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  workers:
    image: ${BACKEND_IMAGE:-biohax-backend:latest}
    restart: unless-stopped
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql://biohax:biohax@postgres:5432/biohax?schema=public}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      OPENROUTER_BASE_URL: ${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      OPENROUTER_PLANNER_MODEL: ${OPENROUTER_PLANNER_MODEL:-openrouter/openai/gpt-4.1-mini}
      OPENROUTER_SAFETY_MODEL: ${OPENROUTER_SAFETY_MODEL:-openrouter/google/gemini-2.0-flash}
      OPENROUTER_NUMERIC_MODEL: ${OPENROUTER_NUMERIC_MODEL:-openrouter/deepseek/deepseek-r1-distill-qwen-32b}
      AUTH_JWT_SECRET: ${AUTH_JWT_SECRET:?AUTH_JWT_SECRET is required}
      AUTH_REFRESH_ENCRYPTION_KEY: ${AUTH_REFRESH_ENCRYPTION_KEY:?AUTH_REFRESH_ENCRYPTION_KEY is required}
      WHOOP_CLIENT_ID: ${WHOOP_CLIENT_ID:-}
      WHOOP_CLIENT_SECRET: ${WHOOP_CLIENT_SECRET:-}
      WHOOP_TOKEN_ENCRYPTION_KEY: ${WHOOP_TOKEN_ENCRYPTION_KEY:?WHOOP_TOKEN_ENCRYPTION_KEY is required}
      WHOOP_TOKEN_KEY_ID: ${WHOOP_TOKEN_KEY_ID:-whoop-token-key-v1}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      WORKER_QUEUES: ${WORKER_QUEUES:-}
      WORKER_POLL_INTERVAL_MS: ${WORKER_POLL_INTERVAL_MS:-5000}
      WORKER_ERROR_BACKOFF_MS: ${WORKER_ERROR_BACKOFF_MS:-2000}
    depends_on:
      postgres:
        condition: service_healthy
    command: ["node", "dist/src/workers/runner.js"]

  frontend:
    image: ${FRONTEND_IMAGE:-biohax-frontend:latest}
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: ${FRONTEND_PORT:-8080}
    ports:
      - "${FRONTEND_PORT:-8080}:8080"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  migrate:
    image: ${BACKEND_IMAGE:-biohax-backend:latest}
    profiles: ["jobs"]
    restart: "no"
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql://biohax:biohax@postgres:5432/biohax?schema=public}
    depends_on:
      postgres:
        condition: service_healthy
    command:
      [
        "npx",
        "prisma",
        "migrate",
        "deploy",
        "--schema",
        "prisma/schema.prisma"
      ]

  seed:
    image: ${BACKEND_IMAGE:-biohax-backend:latest}
    profiles: ["jobs"]
    restart: "no"
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL:-postgresql://biohax:biohax@postgres:5432/biohax?schema=public}
      SEED_MEMBER_EMAIL: ${SEED_MEMBER_EMAIL:-member@example.com}
      SEED_MEMBER_PASSWORD: ${SEED_MEMBER_PASSWORD:-PlaywrightSeedPass1!}
      SEED_ADMIN_EMAIL: ${SEED_ADMIN_EMAIL:-admin@example.com}
      SEED_ADMIN_PASSWORD: ${SEED_ADMIN_PASSWORD:-PlaywrightAdminPass1!}
    depends_on:
      postgres:
        condition: service_healthy
    command: ["node", "dist/scripts/seed.js"]

volumes:
  release_postgres:
